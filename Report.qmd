---
title: "Residency Exams"
author: 
  - name: "Woonggyu Jin"
  - name: "Jack Steel"
  - name: "Sonya Eason"
format: pdf
fig-width: 6
fig-height: 3
geometry: top=0.7in, bottom=1in, left=0.8in, right=0.8in
header-includes:
  - \usepackage{titling}
---

```{r, include=FALSE}
library(lme4)
library(knitr)
library(tidyverse)
library(glmmTMB)
library(broom)
library(emmeans)
library(broom.mixed)
library(patchwork)
library(grid)
library(png)
```

```{r, include=FALSE}
data <- read.table("data.txt",header = TRUE, as.is = TRUE)
```

# Background & Motivation
Prior to practicing full-time medicine, internal medicine students must complete a three year training known as a medical residency. At the end of their medical residency, they are required to pass an examination to obtain their MD. These residency programs are known for their extensive work weeks and rigorous workload. 

In 2003 and 2011, two reform policies were passed to change the structure of internal medicine residency. The 2003 reform, passed on July 1, sought to limit the number of hours worked each week by capping it at 80 hours. The 2011 reform, also passed on July 1, placed stricter limits on which types of activities are permitted during the 80-hour work period. 

These reforms were passed with the goal of improving patient care by decreasing the stress placed on internal medicine residents. In other words, with more time away from the hospital to rest and rejuvenate, students will be more successful at their jobs when they are on their shift. However, limiting the number of hours medical residents can work each week brings about several concerns regarding their performance of the examination at the end of their residency. While some believed a work time limit granted them more time to study, others thought that less hands on work would result in decreased pass rates.

These concerns bring about out motivating question: is there empirical evidence of an association between the reforms and the rate at which the medical residents passed the exam?

# Data Manipulation and Exploratory Data Analysis
The provided data set contains three columns and twenty rows, containing a column for year, number of exam takers, and pass rate as a decimal. Each row represents a single year in which internal medicine residents completed their residency and took the examination. 

```{r, include=FALSE}
data$Pass <- round(data$N * data$Pct)
data$Fail <- (data$N - data$Pass)

data$timeperiod <- rep(1, nrow(data))
data$timeperiod[data$Year > 2002] <- 2
data$timeperiod[data$Year > 2010] <- 3
data$timeperiod <- factor(data$timeperiod, levels = c(1, 2, 3), labels = c("tp1", "tp2", "tp3"))
```

We manipulated the data by adding three additional columns for the number of students that passed the examination, the number of students that failed the examination, and the time period based on the year. The first time period is from 1996-2002, when there was no reform policy in place. The second time period is 2003-2010, when the first reform policy was in place. The third time period is 2011-2015, when the second reform policy was in place (*see: Table 1*).

```{r, include=FALSE}
yP <- data.frame(Year = rep(data$Year, data$Pass), Pass = rep(1, sum(data$Pass)))
yF <- data.frame(Year = rep(data$Year, data$Fail), Pass = rep(0, sum(data$Fail)))
y <- rbind(yP, yF); rm(yP, yF)
y$timeperiod <- rep(1, nrow(y))
y$timeperiod[y$Year > 2002] <- 2
y$timeperiod[y$Year > 2010] <- 3
y$timeperiod <- factor(y$timeperiod, levels = c(1, 2, 3), labels = c("tp1", "tp2", "tp3"))
y$timeperiod <- relevel(y$timeperiod, ref = "tp2")
data$timeperiod <- relevel(data$timeperiod, ref = "tp2")
```

We set time period two as the baseline to make it easier to compare pass rates before and after each policy change. With this setup, the model coefficients directly show whether pass rates were higher in the period before vs. after the first reform, and before vs. after the second reform.

```{r, include=FALSE}
reform_phase_data <- data |>
  mutate(
    ReformPolicy = case_when(
      Year < 2003 ~ "No Reform",
      Year < 2006 ~ "Phasing in Reform One",
      Year < 2011 ~ "Reform One",
      Year < 2014 ~ "Phasing in Reform Two",
      Year < 2016 ~ "Reform Two"
    )
  ) 
```

Figure 1 displays the medical resident exam pass rate over the years 1996 to 2015. Because the effects of policy changes might take time to appear, given that internal medicine residency lasts three years, we also considered phase-in periods. To capture this, we divided the plot into five sections. The original three time periods (no reform policy, reform policy one, and reform policy two) were each split further into a phase-in period and a full policy period. The phase-in period represents the three years when residents experienced a mix of the old and new policies during their training.

Students that fall in the section "Phasing in Reform One" (green dots on Figure 1), had experienced both no reform policy and reform policy one. Students that fall in the section "Phasing in Reform Two" (teal dots on Figure 1), had experienced both reform policy one and reform policy two during their residency. 

As can be seen from Figure 1, students that took the examination in years where they experienced some amount of reform policy one appeared to perform better than students that took the examination in years where they experience no reform policy or some amount of reform policy two. 

# Model Implementation Details

### Model 1 - Binomial Mixture

```{r, include=FALSE}
model <- glmer(
  Pass ~ timeperiod + (1 | Year),
  data = y,
  family = binomial(link = "logit")
)
```
We reasonably assumed that exam pass rates contain unobserved year-to-year variation, such as differences in exam difficulty or cohort quality. To capture this extra source of randomness, we fit a binomial mixture model by including a random intercept for each year. This approach allowed us to separate systematic effects of reform policies from idiosyncratic annual noise.

We fit a generalized linear mixed model (GLMM) with a logit link, specifying pass/fail outcomes as the response and reform time period as the fixed effect, with year as a random effect (*see: Equation 1*)

### Model 2 - Beta-binomial
```{r, include=FALSE}
beta_binomial_model <- glmmTMB(
  cbind(Pass, Fail) ~ timeperiod,
  data = data,
  family = betabinomial(link = "logit")
)
```

The binomial assumption may underestimate variability in exam outcomes because pass probabilities likely vary within each period. To allow for overdispersion, we modeled the yearly pass probabilities as Beta-distributed. This approach treats exam outcomes as binomially distributed, with their underlying pass rate following a Beta distribution, allowing variability beyond what a simple binomial model would capture.

We fit a beta-binomial regression with time period as the predictor using the glmmTMB package with a logit link. The model structure is described in equation 2.

Here, dispersion was estimated directly from the data, accounting for extra variation.

### Model 3 - Beta-binomial on subset
```{r, include=FALSE}
reform_data <- data %>%
  filter(Year < 2003 | (Year >= 2006 & Year <= 2010) | (Year >= 2014 & Year <= 2015)) 
reform_data$timeperiod <- factor(reform_data$timeperiod, levels = c("tp1","tp2","tp3"))
reform_data$timeperiod <- relevel(reform_data$timeperiod, ref = "tp2")
```

```{r, include=FALSE}
beta_binomial_model_subsets <- glmmTMB(
  cbind(Pass, Fail) ~ timeperiod,
  data = reform_data,
  family = betabinomial(link = "logit")
)
```
Because policy reforms were phased in gradually, exam cohorts in transition years likely had mixed exposure. To avoid contamination, we fit the beta-binomial model on a restricted dataset excluding these phase-in years. This design isolates the effect of reforms once they were fully implemented.

We restricted the dataset to years 1996–2002, 2006–2010, and 2014–2015. The same beta-binomial specification was used, with time period as the predictor and a logit link for the mean pass probability.

# Model Evaluation

To check goodness of fit, we plotted Pearson residuals over time. We appear to minimize residuals over time in the mixture model, as seen in Figure 2. Putting this together, we concluded that the full beta-binomial mixture model is the best fit (*see: Figure 2*).

# Shortcomings

One challenge was finding evaluation metrics that could be compared across models. We first tried using AIC, but this was not reliable since different packages calculate it differently, and AIC depends on the likelihood, which changes when models use different numbers of observations.

For future work, Bayesian models could be helpful since they would let us incorporate additional information into the analysis. We also plan to explore other comparable measures of model fit and parsimony.

# Conclusion
We concluded that the binomial mixture model is the best fit. With that model, we found that the first reform increased the odds of passing, while the second reform was associated with a decline in performance. Both of these were confirmed by significant coefficients (*see: Table 2, Figure 3*)

```{r, include=FALSE}
emm <- emmeans(model, ~ timeperiod, type = "response", re.form = NA)
step <- as.data.frame(emm) %>%
  mutate(period = c("tp2","tp1","tp3")) %>%
  arrange(period)

nm_mean  <- intersect(names(step), c("response","prob","emmean"))[1]
nm_lower <- intersect(names(step), c("lower.CL","asymp.LCL"))[1]
nm_upper <- intersect(names(step), c("upper.CL","asymp.UCL"))[1]

step$response <- step[[nm_mean]]
step$lower.CL <- step[[nm_lower]]
step$upper.CL <- step[[nm_upper]]

step$xmin <- c(1996, 2003, 2011)
step$xmax <- c(2002, 2010, 2015)
```

\newpage

# Appendix

```{r}
#| echo: false
#| tbl-cap: "First three rows of the dataset after adding pass/fail counts and reform time period."
#| label: tbl:data-head
kable(head(data, n = 3))
```

```{r, echo=FALSE}
reform_phase_data |>
  ggplot(aes(x = Year, y = Pct, color = ReformPolicy)) +
  geom_point(size = 2) +
    labs(
      x = "Year",
      y = "Medical Resident Exam Pass Rate",
      title = "Medical Resident Exam Pass Rate throughout Reforms",
      caption = str_wrap("Figure 1: Internal medicine resident exam pass rate over time periods for no reform (1996-2002), phasing in reform one (2003-2005), reform one (2006-2010), phasing in reform two (2011-2013), and reform two (2014-2015).")
    ) + 
  geom_vline(xintercept = c(2002.5, 2005.5, 2010.5, 2013.5)) + 
  geom_vline(xintercept = c(2002.5, 2005.5, 2010.5, 2013.5), color="red3") +
  theme_minimal() + 
  theme(plot.caption = element_text(hjust = 0))
```

\begin{equation}
\text{Pass}_{iy} \sim \text{Binomial}(n_{iy}, p_{iy}), \quad 
\text{logit}(p_{iy}) = \alpha + \beta \cdot \text{timeperiod}_{iy} + u_y, 
\quad u_y \sim N(0, \sigma^2).
\label{eq:binom-mix}
\end{equation}

\begin{equation}
\pi_y \sim \text{Beta}(\alpha, \beta), \quad 
\text{Pass}_y \sim \text{Binomial}(n_y, \pi_y).
\label{eq:betabinom}
\end{equation}

```{r echo=FALSE,fig.show="hold"}
img1 <- readPNG("residuals_full_vs_subset.png")
img2 <- readPNG("residuals_full_vs_mixture.png")

p1 <- ggplot() + 
  annotation_custom(rasterGrob(img1, width=unit(1,"npc"), height=unit(1,"npc"))) +
  theme_void()

p2 <- ggplot() + 
  annotation_custom(rasterGrob(img2, width=unit(1,"npc"), height=unit(1,"npc"))) +
  theme_void()

combined <- p1 + p2 + 
  plot_annotation(
    caption = "Figure Two: Pearson Residuals Plotted by Year for Full Beta-Binomial Model Compared to Subsetted Model Fits and Mixture Binomial Model"
  )

combined

```

```{r}
#| echo: false
#| tbl-cap: "GLMM (binomial mixture) fixed-effect coefficients (reference period: tp2)."
#| label: tbl:glmm-coef
tidy(model, effects = "fixed") |>
  dplyr::select(term, estimate, std.error, statistic, p.value) |>
  knitr::kable(digits = 4)
```

```{r}
#| label: fig:glmm-final
#| echo: false
ggplot(data, aes(x = Year, y = Pass/N)) +
  geom_point(color = "forestgreen") +
  geom_vline(xintercept = c(2003, 2011), color = "red3") +
  geom_segment(data = step,
               aes(x = xmin, xend = xmax, y = response, yend = response),
               inherit.aes = FALSE, linewidth = 1) +
  geom_segment(data = step,
               aes(x = xmin, xend = xmax, y = lower.CL, yend = lower.CL),
               inherit.aes = FALSE, linetype = "dotted") +
  geom_segment(data = step,
               aes(x = xmin, xend = xmax, y = upper.CL, yend = upper.CL),
               inherit.aes = FALSE, color = "black", linetype = "dotted") +
  labs(title = "Pass Rates by Year with GLMM (binomial) Step Fit",
       y = "Pass Rate",
       caption = str_wrap("Figure Three: Internal medicine examination pass rates are plotted against year. Horizontal solid lines represent pass rates chosen by the binomial mixture model for no reform, reform one, and reform two. Dotted lines represent 95% confidence interval for pass rate.")
       ) + 
  coord_cartesian(ylim = c(0.80, 0.96)) +
  theme_minimal() + 
  theme(plot.caption = element_text(hjust = 0))
```
